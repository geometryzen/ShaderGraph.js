(function(){function e(d,a,k){if(d===a)return 0!==d||1/d==1/a;if(null==d||null==a)return d===a;d._chain&&(d=d._wrapped);a._chain&&(a=a._wrapped);if(d.isEqual&&c.isFunction(d.isEqual))return d.isEqual(a);if(a.isEqual&&c.isFunction(a.isEqual))return a.isEqual(d);var b=l.call(d);if(b!=l.call(a))return!1;switch(b){case "[object String]":return d==""+a;case "[object Number]":return d!=+d?a!=+a:0==d?1/d==1/a:d==+a;case "[object Date]":case "[object Boolean]":return+d==+a;case "[object RegExp]":return d.source==
a.source&&d.global==a.global&&d.multiline==a.multiline&&d.ignoreCase==a.ignoreCase}if("object"!=typeof d||"object"!=typeof a)return!1;for(var f=k.length;f--;)if(k[f]==d)return!0;k.push(d);var f=0,h=!0;if("[object Array]"==b){if(f=d.length,h=f==a.length)for(;f--&&(h=f in d==f in a&&e(d[f],a[f],k)););}else{if("constructor"in d!="constructor"in a||d.constructor!=a.constructor)return!1;for(var g in d)if(c.has(d,g)&&(f++,!(h=c.has(a,g)&&e(d[g],a[g],k))))break;if(h){for(g in a)if(c.has(a,g)&&!f--)break;
h=!f}}k.pop();return h}var a=this,b=a._,f={},h=Array.prototype,j=Object.prototype,g=h.slice,m=h.unshift,l=j.toString,H=j.hasOwnProperty,q=h.forEach,y=h.map,z=h.reduce,A=h.reduceRight,B=h.filter,C=h.every,D=h.some,s=h.indexOf,E=h.lastIndexOf,j=Array.isArray,I=Object.keys,t=Function.prototype.bind,c=function(d){return new p(d)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports._=c):a._=c;c.VERSION="1.3.3";var n=c.each=c.forEach=function(d,
a,k){if(null!=d)if(q&&d.forEach===q)d.forEach(a,k);else if(d.length===+d.length)for(var b=0,e=d.length;b<e&&!(b in d&&a.call(k,d[b],b,d)===f);b++);else for(b in d)if(c.has(d,b)&&a.call(k,d[b],b,d)===f)break};c.map=c.collect=function(d,a,c){var b=[];if(null==d)return b;if(y&&d.map===y)return d.map(a,c);n(d,function(d,f,e){b[b.length]=a.call(c,d,f,e)});d.length===+d.length&&(b.length=d.length);return b};c.reduce=c.foldl=c.inject=function(d,a,k,b){var f=2<arguments.length;null==d&&(d=[]);if(z&&d.reduce===
z)return b&&(a=c.bind(a,b)),f?d.reduce(a,k):d.reduce(a);n(d,function(d,c,e){f?k=a.call(b,k,d,c,e):(k=d,f=!0)});if(!f)throw new TypeError("Reduce of empty array with no initial value");return k};c.reduceRight=c.foldr=function(d,a,k,b){var f=2<arguments.length;null==d&&(d=[]);if(A&&d.reduceRight===A)return b&&(a=c.bind(a,b)),f?d.reduceRight(a,k):d.reduceRight(a);var e=c.toArray(d).reverse();b&&!f&&(a=c.bind(a,b));return f?c.reduce(e,a,k,b):c.reduce(e,a)};c.find=c.detect=function(d,a,c){var b;F(d,function(d,
f,e){if(a.call(c,d,f,e))return b=d,!0});return b};c.filter=c.select=function(d,a,c){var b=[];if(null==d)return b;if(B&&d.filter===B)return d.filter(a,c);n(d,function(d,f,e){a.call(c,d,f,e)&&(b[b.length]=d)});return b};c.reject=function(d,a,c){var b=[];if(null==d)return b;n(d,function(d,f,e){a.call(c,d,f,e)||(b[b.length]=d)});return b};c.every=c.all=function(d,a,c){var b=!0;if(null==d)return b;if(C&&d.every===C)return d.every(a,c);n(d,function(d,e,h){if(!(b=b&&a.call(c,d,e,h)))return f});return!!b};
var F=c.some=c.any=function(d,a,b){a||(a=c.identity);var e=!1;if(null==d)return e;if(D&&d.some===D)return d.some(a,b);n(d,function(d,c,h){if(e||(e=a.call(b,d,c,h)))return f});return!!e};c.include=c.contains=function(d,a){return null==d?!1:s&&d.indexOf===s?-1!=d.indexOf(a):F(d,function(d){return d===a})};c.invoke=function(d,a){var b=g.call(arguments,2);return c.map(d,function(d){return(c.isFunction(a)?a||d:d[a]).apply(d,b)})};c.pluck=function(d,a){return c.map(d,function(d){return d[a]})};c.max=function(d,
a,b){if(!a&&c.isArray(d)&&d[0]===+d[0])return Math.max.apply(Math,d);if(!a&&c.isEmpty(d))return-Infinity;var f={computed:-Infinity};n(d,function(d,c,e){c=a?a.call(b,d,c,e):d;c>=f.computed&&(f={value:d,computed:c})});return f.value};c.min=function(d,a,b){if(!a&&c.isArray(d)&&d[0]===+d[0])return Math.min.apply(Math,d);if(!a&&c.isEmpty(d))return Infinity;var f={computed:Infinity};n(d,function(d,c,e){c=a?a.call(b,d,c,e):d;c<f.computed&&(f={value:d,computed:c})});return f.value};c.shuffle=function(d){var a=
[],c;n(d,function(d,b){c=Math.floor(Math.random()*(b+1));a[b]=a[c];a[c]=d});return a};c.sortBy=function(d,a,b){var f=c.isFunction(a)?a:function(d){return d[a]};return c.pluck(c.map(d,function(d,a,c){return{value:d,criteria:f.call(b,d,a,c)}}).sort(function(d,a){var c=d.criteria,b=a.criteria;return void 0===c?1:void 0===b?-1:c<b?-1:c>b?1:0}),"value")};c.groupBy=function(d,a){var b={},f=c.isFunction(a)?a:function(d){return d[a]};n(d,function(d,a){var c=f(d,a);(b[c]||(b[c]=[])).push(d)});return b};c.sortedIndex=
function(d,a,b){b||(b=c.identity);for(var f=0,e=d.length;f<e;){var h=f+e>>1;b(d[h])<b(a)?f=h+1:e=h}return f};c.toArray=function(d){return!d?[]:c.isArray(d)||c.isArguments(d)?g.call(d):d.toArray&&c.isFunction(d.toArray)?d.toArray():c.values(d)};c.size=function(d){return c.isArray(d)?d.length:c.keys(d).length};c.first=c.head=c.take=function(d,a,c){return null!=a&&!c?g.call(d,0,a):d[0]};c.initial=function(d,a,c){return g.call(d,0,d.length-(null==a||c?1:a))};c.last=function(d,a,c){return null!=a&&!c?
g.call(d,Math.max(d.length-a,0)):d[d.length-1]};c.rest=c.tail=function(d,a,c){return g.call(d,null==a||c?1:a)};c.compact=function(d){return c.filter(d,function(d){return!!d})};c.flatten=function(d,a){return c.reduce(d,function(d,b){if(c.isArray(b))return d.concat(a?b:c.flatten(b));d[d.length]=b;return d},[])};c.without=function(d){return c.difference(d,g.call(arguments,1))};c.uniq=c.unique=function(d,a,b){b=b?c.map(d,b):d;var f=[];3>d.length&&(a=!0);c.reduce(b,function(b,e,k){if(a?c.last(b)!==e||
!b.length:!c.include(b,e))b.push(e),f.push(d[k]);return b},[]);return f};c.union=function(){return c.uniq(c.flatten(arguments,!0))};c.intersection=c.intersect=function(d){var a=g.call(arguments,1);return c.filter(c.uniq(d),function(d){return c.every(a,function(a){return 0<=c.indexOf(a,d)})})};c.difference=function(d){var a=c.flatten(g.call(arguments,1),!0);return c.filter(d,function(d){return!c.include(a,d)})};c.zip=function(){for(var d=g.call(arguments),a=c.max(c.pluck(d,"length")),b=Array(a),f=
0;f<a;f++)b[f]=c.pluck(d,""+f);return b};c.indexOf=function(d,a,b){if(null==d)return-1;var f;if(b)return b=c.sortedIndex(d,a),d[b]===a?b:-1;if(s&&d.indexOf===s)return d.indexOf(a);b=0;for(f=d.length;b<f;b++)if(b in d&&d[b]===a)return b;return-1};c.lastIndexOf=function(d,a){if(null==d)return-1;if(E&&d.lastIndexOf===E)return d.lastIndexOf(a);for(var b=d.length;b--;)if(b in d&&d[b]===a)return b;return-1};c.range=function(d,a,b){1>=arguments.length&&(a=d||0,d=0);b=arguments[2]||1;for(var c=Math.max(Math.ceil((a-
d)/b),0),f=0,e=Array(c);f<c;)e[f++]=d,d+=b;return e};var G=function(){};c.bind=function(d,a){var b,f;if(d.bind===t&&t)return t.apply(d,g.call(arguments,1));if(!c.isFunction(d))throw new TypeError;f=g.call(arguments,2);return b=function(){if(!(this instanceof b))return d.apply(a,f.concat(g.call(arguments)));G.prototype=d.prototype;var c=new G,e=d.apply(c,f.concat(g.call(arguments)));return Object(e)===e?e:c}};c.bindAll=function(a){var b=g.call(arguments,1);0==b.length&&(b=c.functions(a));n(b,function(b){a[b]=
c.bind(a[b],a)});return a};c.memoize=function(a,b){var f={};b||(b=c.identity);return function(){var e=b.apply(this,arguments);return c.has(f,e)?f[e]:f[e]=a.apply(this,arguments)}};c.delay=function(a,b){var c=g.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)};c.defer=function(a){return c.delay.apply(c,[a,1].concat(g.call(arguments,1)))};c.throttle=function(a,b){var f,e,h,g,j,m,q=c.debounce(function(){j=g=!1},b);return function(){f=this;e=arguments;h||(h=setTimeout(function(){h=
null;j&&a.apply(f,e);q()},b));g?j=!0:m=a.apply(f,e);q();g=!0;return m}};c.debounce=function(a,b,c){var f;return function(){var e=this,h=arguments;c&&!f&&a.apply(e,h);clearTimeout(f);f=setTimeout(function(){f=null;c||a.apply(e,h)},b)}};c.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}};c.wrap=function(a,b){return function(){var c=[a].concat(g.call(arguments,0));return b.apply(this,c)}};c.compose=function(){var a=arguments;return function(){for(var b=
arguments,c=a.length-1;0<=c;c--)b=[a[c].apply(this,b)];return b[0]}};c.after=function(a,b){return 0>=a?b():function(){if(1>--a)return b.apply(this,arguments)}};c.keys=I||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],f;for(f in a)c.has(a,f)&&(b[b.length]=f);return b};c.values=function(a){return c.map(a,c.identity)};c.functions=c.methods=function(a){var b=[],f;for(f in a)c.isFunction(a[f])&&b.push(f);return b.sort()};c.extend=function(a){n(g.call(arguments,1),function(b){for(var c in b)a[c]=
b[c]});return a};c.pick=function(a){var b={};n(c.flatten(g.call(arguments,1)),function(c){c in a&&(b[c]=a[c])});return b};c.defaults=function(a){n(g.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])});return a};c.clone=function(a){return!c.isObject(a)?a:c.isArray(a)?a.slice():c.extend({},a)};c.tap=function(a,b){b(a);return a};c.isEqual=function(a,b){return e(a,b,[])};c.isEmpty=function(a){if(null==a)return!0;if(c.isArray(a)||c.isString(a))return 0===a.length;for(var b in a)if(c.has(a,
b))return!1;return!0};c.isElement=function(a){return!!(a&&1==a.nodeType)};c.isArray=j||function(a){return"[object Array]"==l.call(a)};c.isObject=function(a){return a===Object(a)};c.isArguments=function(a){return"[object Arguments]"==l.call(a)};c.isArguments(arguments)||(c.isArguments=function(a){return!(!a||!c.has(a,"callee"))});c.isFunction=function(a){return"[object Function]"==l.call(a)};c.isString=function(a){return"[object String]"==l.call(a)};c.isNumber=function(a){return"[object Number]"==
l.call(a)};c.isFinite=function(a){return c.isNumber(a)&&isFinite(a)};c.isNaN=function(a){return a!==a};c.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==l.call(a)};c.isDate=function(a){return"[object Date]"==l.call(a)};c.isRegExp=function(a){return"[object RegExp]"==l.call(a)};c.isNull=function(a){return null===a};c.isUndefined=function(a){return void 0===a};c.has=function(a,b){return H.call(a,b)};c.noConflict=function(){a._=b;return this};c.identity=function(a){return a};c.times=
function(a,b,c){for(var f=0;f<a;f++)b.call(c,f)};c.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};c.result=function(a,b){if(null==a)return null;var f=a[b];return c.isFunction(f)?f.call(a):f};c.mixin=function(a){n(c.functions(a),function(b){var f=c[b]=a[b];p.prototype[b]=function(){var a=g.call(arguments);m.call(a,this._wrapped);return u(f.apply(c,a),this._chain)}})};var J=0;c.uniqueId=
function(a){var b=J++;return a?a+b:b};c.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var v=/.^/,r={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"},w;for(w in r)r[r[w]]=w;var K=/\\|'|\r|\n|\t|\u2028|\u2029/g,L=/\\(\\|'|r|n|t|u2028|u2029)/g,x=function(a){return a.replace(L,function(a,b){return r[b]})};c.template=function(a,b,f){f=c.defaults(f||{},c.templateSettings);a="__p+='"+a.replace(K,function(a){return"\\"+r[a]}).replace(f.escape||
v,function(a,b){return"'+\n_.escape("+x(b)+")+\n'"}).replace(f.interpolate||v,function(a,b){return"'+\n("+x(b)+")+\n'"}).replace(f.evaluate||v,function(a,b){return"';\n"+x(b)+"\n;__p+='"})+"';\n";f.variable||(a="with(obj||{}){\n"+a+"}\n");a="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+a+"return __p;\n";var e=new Function(f.variable||"obj","_",a);if(b)return e(b,c);b=function(a){return e.call(this,a,c)};b.source="function("+(f.variable||"obj")+"){\n"+a+"}";return b};
c.chain=function(a){return c(a).chain()};var p=function(a){this._wrapped=a};c.prototype=p.prototype;var u=function(a,b){return b?c(a).chain():a};c.mixin(c);n("pop push reverse shift sort splice unshift".split(" "),function(a){var b=h[a];p.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var f=c.length;("shift"==a||"splice"==a)&&0===f&&delete c[0];return u(c,this._chain)}});n(["concat","join","slice"],function(a){var b=h[a];p.prototype[a]=function(){return u(b.apply(this._wrapped,arguments),
this._chain)}});p.prototype.chain=function(){this._chain=!0;return this};p.prototype.value=function(){return this._wrapped}}).call(this);(function(e){for(var a in e)if(!window[a])throw"Error: ShaderGraph requires "+e[a];})({THREE:"Three.js"});window.ShaderGraph={};ShaderGraph.getShader=function(e){var a=document.getElementById(e);return a&&(a.innerText||a.textContent)||e};
(function(e){e.Block=function(a){a=a||new e.Node;this.node(a);this.children=[];this.parent=null;this.properties={};this.index=++e.Block.index;this.refresh()};e.Block.index=0;e.Block.prototype={node:function(a){return void 0!==a?(this._node=a,this):this._node},refresh:function(){this._node.owner(this);this._node.outlets(this.outlets())},fetch:function(){},id:function(a,b,f,h){if(f.meta.inout){var j=f.node.get(f.name,e.IN).input;if(j)return j.node.owner().fetch(a,b,j,h+1)}return f.id()}};e.Block.Snippet=
function(a){this.snippet=new e.Snippet(a);e.Block.call(this)};e.Block.Snippet.prototype=_.extend({},e.Block.prototype,{insert:function(a,b,f){e.Block.Snippet.compileCall(a,b,this.node(),this.snippet,f)},fetch:function(a,b,f,e){a.include(this,b)||this.insert(a,b,e);return this.id(a,b,f,e)},outlets:function(){return e.Block.Snippet.makeOutlets(this.snippet)}});e.Block.Material=function(a,b){this.vertex=new e.Snippet(a);this.fragment=new e.Snippet(b);e.Block.call(this)};e.Block.Material.prototype=_.extend({},
e.Block.prototype,{compile:function(){if(0<this.node().outputs.length)throw"Can't compile material with outputs";this.node();var a=new e.Program;this.insert(a,"vertex",0);this.insert(a,"fragment",0);a.compile();return a},insert:function(a,b,f){e.Block.Snippet.compileCall(a,b,this.node(),this[b],f)},fetch:function(a,b,f,e){a.include(this,b)||this.insert(a,b,e);"fragment"==b&&(a.include(this,"vertex")||this.insert(a,"vertex",0));return this.id(a,b,f,e)},outlets:function(){var a=e.Block.Snippet.makeOutlets(this.vertex),
b=e.Block.Snippet.makeOutlets(this.fragment);return _.union(a,b)}});e.Block.Snippet.makeOutlets=function(a){var b=[];if(a.outlets)return a.outlets;var f=a.arguments();_.each(f.parameters,function(a){a=_.extend({},a);a.meta={required:!0};a.hint=a.name.replace(/(In|Out)$/,"");a.category="parameter";if(a.inout==e.INOUT){a.meta.inout=!0;var f=_.extend({},a);f.inout=e.IN;b.push(f);a.inout=e.OUT}b.push(a)});_.each(f.uniforms,function(a){a.meta={};a.hint=a.name.replace(/(In|Out)$/,"");a.category="uniform";
a.inout=e.IN;b.push(a)});return a.outlets=b};e.Block.Snippet.compileCall=function(a,b,f,h,j){var g=h.arguments(),m=[];_.each(g.parameters,function(g){var h=f.get(g.name,g.inout==e.INOUT?e.IN:g.inout);if(g.inout==e.IN||g.inout==e.INOUT)if(h.input)h=h.input.node.owner().fetch(a,b,h.input,j+1),a.variable(b,h,g),m.push(h);else throw console.log("Outlet",g,input),["Missing connection on outlet for "+g.name];else g.inout==e.OUT&&(h=h.id(),a.variable(b,h,g),m.push(h))});var l=[];_.each(g.uniforms,function(e){var g=
f.get(e.name);g.input?(g=g.input.node.owner().fetch(a,b,g.input,j+1),a.variable(b,g,e),m.push(g),l.push(e.name)):a.external("uniform",e)});_.each(g.attributes,function(b){a.external("attribute",b)});_.each(g.varyings,function(b){a.external("varying",b)});g=["_sg",b,h.name,f.owner().index].join("_");h=h.compile(g,l,!0);a.add(b,g,m,h,j)}})(ShaderGraph);
(function(e){e.Factory=function(){this.end()};e.Factory.prototype={snippet:function(a,b){b=b||"append";var f=new e.Block.Snippet(ShaderGraph.getShader(a));this[b](f.node());return this},material:function(a,b,f){f=f||"append";a=new e.Block.Material(ShaderGraph.getShader(a),ShaderGraph.getShader(b));this[f](a.node());return this},snippetBefore:function(a){this.snippet(a,"prepend");return this},materialBefore:function(){this.material(code,"prepend");return this},append:function(a){a.graph||this.graph.add(a);
var b=this.stack[0];_.each(b.end,function(b){b.connect(a)});b.start.length||(b.start=[a]);b.end=[a];return this},prepend:function(a){a.graph||this.graph.add(a);var b=this.stack[0];_.each(b.start,function(b){a.connect(b)});b.end.length||(b.end=[a]);b.start=[a];return this},group:function(){this.stack.unshift({start:[],end:[]});this.stack.unshift({start:[],end:[]});return this},next:function(){var a=this.stack.shift(),b=this.stack[0];b.start=b.start.concat(a.start);b.end=b.end.concat(a.end);this.stack.unshift({start:[],
end:[]});return this},combine:function(){if(2>=this.stack.length)throw"Popping factory stack too far.";this.next();this.stack.shift();var a=this.stack.shift(),b=this.stack[0];_.each(a.start,function(a){_.each(b.end,function(b){b.connect(a,!0)})});b.end=a.end;return this},end:function(){var a=this.graph;this.graph=new e.Graph;this.stack=[];this.group();a&&(a.compile=function(){return a.tail().owner().compile()});return a}}})(ShaderGraph);
(function(e){e.Program=function(){this.calls={vertex:{},fragment:{}};this.variables={vertex:{},fragment:{}};this.externals={};this.compiled=!1;this.attributes={};this.uniforms={};this.fragmentShader=this.vertexShader="";this.includes={vertex:[],fragment:[]}};e.Program.types={f:"float",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4",t:"sampler2D"};e.Program.prototype={include:function(a,b){if(0<=this.includes[b].indexOf(a))return!0;this.includes[b].push(a);return!1},external:function(a,b){b=_.extend({category:a},
b);this.externals[b.name]=b},variable:function(a,b,f){f=_.extend({},f,{name:b});this.variables[a][b]=f},add:function(a,b,f,e,j){var g=this.calls[a][b];g?g.priority=Math.min(g.priority,j):this.calls[a][b]={name:b,args:f,code:e,priority:j}},compile:function(){_.each(this.externals,function(a){"uniform"==a.category&&(this.uniforms[a.name]={type:a.type,value:a.value});"attribute"==a.category&&(this.attributes[a.name]={type:a.type,value:[]})}.bind(this));_.each(["vertex","fragment"],function(a){var b=
[];_.each(this.externals,function(f){"attribute"==f.category&&"fragment"==a||b.push([f.category,f.signature,";"].join(" "))}.bind(this));var b=b.join("\n"),f=_.toArray(this.calls[a]),h=[b],j=["void main() {"];_.each(this.variables[a],function(a){j.push([e.Program.types[a.type],a.name,";"].join(" "))});f.sort(function(a,b){return b.priority-a.priority});_.each(f,function(a){h.push(a.code);j.push([a.name,"(",a.args.join(","),");"].join(""))});j.push("}");this[a+"Shader"]=[h.join("\n"),j.join("\n")].join("\n")}.bind(this));
this.compiled=!0},material:function(){if(!this.compiled)throw"Fetching material from uncompiled program.";return new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:this.vertex,fragmentShader:this.fragment})}}})(ShaderGraph);
(function(e){e.Snippet=function(a){if(e.Snippet.cache[a])return e.Snippet.cache[a];e.Snippet.cache[a]=this;this.code=a;this.attributes=[];this.uniforms=[];this.varyings=[];this.parameters=[];this.body=this.signature="";this.parseCode(a)};e.Snippet.cache={};e.Snippet.types={"float":"f",vec2:"v2",vec3:"v3",vec4:"v4",mat3:"m3",mat4:"m4",sampler2D:"t",samplerCube:"t"};e.Snippet.defaults={"float":0,vec2:new THREE.Vector3,vec3:new THREE.Vector3,vec4:new THREE.Vector4,mat4:new THREE.Matrix4,sampler2D:0,
samplerCube:0};e.Snippet.prototype={compile:function(a,b,f){var e=this.signature.slice(),j=[];b=b||[];_.each(this.uniforms,function(a){0<=b.indexOf(a.name)?e.push(a.signature):f||j.push(["uniform",a.signature].join(" "))});!f&&_.each(this.attributes,function(a){j.push(["attribute",a.signature].join(" "))});!f&&_.each(this.varyings,function(a){j.push(["varying",a.signature].join(" "))});a=this.body.replace(/\s*void\s+([A-Za-z0-9]+)\s*\([^\)]*\)/g,["void",a+"(",e.join(", "),")"].join(" "));j.push(a);
return j.join(";\n")},arguments:function(){return{uniforms:this.uniforms,varyings:this.varyings,attributes:this.attributes,parameters:this.parameters}},type:function(a,b){a=(e.Snippet.types[a]||"f")+(b?"v":"");return"fv"==a?"fv1":a},parseAttribute:function(a){var b=a[1];this.attributes.push({name:a[3],type:this.type(a[2],a[4]),signature:b})},parseUniform:function(a){var b=a[1],f=a[2];this.uniforms.push({name:a[3],type:this.type(f,a[4]),value:e.Snippet.defaults[f]||0,signature:b})},parseVarying:function(a){var b=
a[1];this.varyings.push({name:a[3],type:this.type(a[2],a[4]),signature:b})},parseSignature:function(a){this.name=a[1];var b=a[2].replace(/^\s*$/g,"");0==b.length?this.signature=[]:(arguments=this.signature=b.split(","),_.each(arguments,function(a){a=/((?:(in|out|inout)\s+)?([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/.exec(a);var b=a[1];this.parameters.push({inout:{"in":e.IN,out:e.OUT,inout:e.INOUT}[a[2]||"in"],name:a[4],type:this.type(a[3],a[5]),signature:b})}.bind(this)))},parseCode:function(a){function b(a,
b){if(!a.global)throw"Can't findAll non-global regexp";for(var f,e=[];f=a.exec(b);)e.push(f);return e}a=a.replace(/\r\n?/g,"\n").replace(/\/\/[^\n]*\n/g," ").replace(/\/\*(.|\n)*?\*\//g," ");var f=b(/(?:^|;)\s*attribute\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),e=b(/(?:^|;)\s*uniform\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),j=b(/(?:^|;)\s*varying\s+(([A-Za-z0-9]+)\s+([[A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),g=b(/(?:^|;)\s*void\s+([A-Za-z0-9]+)\s*\(([^\)]*)\)\s*{/g,
a);if(!g[0])throw"Could not parse shader snippet. Must contain a void-returning function with in/outs: "+a;var m=a;_.each({parseAttribute:f,parseUniform:e,parseVarying:j},function(a,b){_.each(a,function(a){this[b](a);m=m.replace(a[0],"")}.bind(this))}.bind(this));m=m.replace(/^\s*;/,"");this.parseSignature(g[0]);this.body=m}}})(ShaderGraph);
(function(e){e.Graph=function(a,b){this.parent=b||null;this.nodes=[];a&&this.add(a)};e.Graph.prototype={iterate:function(a){_.each(this.nodes,function(b){a(b,b._owner)})},exposed:function(){var a=[];this.iterate(function(b){_.each(b.outlets(),function(b){b.exposed&&a.push(b)})});return a},inputs:function(){var a=[];this.iterate(function(b){_.each(b.inputs,function(b){null==b.input&&a.push(b)})});return a},outputs:function(){var a=[];this.iterate(function(b){_.each(b.outputs,function(b){0==b.output.length&&
a.push(b)})});return a},tail:function(){return this.nodes[this.nodes.length-1]},add:function(a){if(a.constructor==Array)return _.each(a,function(a){this.add(a)}.bind(this));if(a.graph)throw"Adding node to two graphs at once";a.link(this);this.nodes.push(a)},remove:function(a,b){var f=this;if(a.constructor==Array)return _.each(a,function(a){f.remove(a)});if(a.graph!=this)throw"Removing node from wrong graph.";b||a.disconnect();this.nodes.splice(this.nodes.indexOf(a),1)}};e.IN=0;e.OUT=1;e.INOUT=2})(ShaderGraph);
(function(e){e.Node=function(a,b){this.graph=null;this.inputs=[];this.outputs=[];this._outlets={};this.owner(a);this.outlets(b)};e.Node.prototype={owner:function(a){return void 0!==a?(this._owner=a,this):this._owner},link:function(a){this.graph=a},getIn:function(a){return this.get(a,e.IN)},getOut:function(a){return this.get(a,e.OUT)},get:function(a,b){return void 0===b?this.get(a,e.IN)||this.get(a,e.OUT):this._outlets[[a,b].join("-")]},key:function(a){return[a.name,a.inout].join("-")},outlets:function(a){if(void 0!==
a){var b={};_.each(a,function(a){b[[a.name,a.inout,a.type].join("-")]=!0}.bind(this));_.each(this._outlets,function(a){b[[a.name,a.inout,a.type].join("-")]||this.remove(a)}.bind(this));_.each(a,function(a){var b=this.get(a.name,a.inout);b?b.morph(a):(a=new e.Outlet(a),this.add(a))}.bind(this));return this}return this._outlets},add:function(a){var b=this.key(a);outlets=this._outlets;_in=this.inputs;_out=this.outputs;if(a.node)throw"Adding outlet to two nodes at once.";if(outlets[b])throw"Adding two identical outlets to same node.";
a.link(this);outlets[b]=a;(a.inout==e.IN?_in:_out).push(a);return this},remove:function(a){var b=this._outlets,f=this.key(a),h=a.inout==e.IN?this.inputs:this.outputs;if(a.node!=this)throw"Removing outlet from wrong node.";a.disconnect();a.link(null);delete b[f];h.splice(h.indexOf(a),1);return this},connect:function(a,b,f){var e={},j={};_.each(a.inputs,function(a){if(f||!a.input){var b=a.type,l=[b,a.hint].join("-");j[l]||(j[l]=a);e[b]=e[b]||[];e[b].push(a)}});_.each(this.outputs,function(a){if(!b||
!a.output.length){var f=a.type,l=[f,a.hint].join("-");j[l]?(j[l].connect(a),delete j[l],e[f].splice(e[f].indexOf(a),1)):e[f]&&e[f].length&&e[f].shift().connect(a)}});return this},disconnect:function(){_.each(this.inputs,function(a){a.disconnect()});_.each(this.outputs,function(a){a.disconnect()});return this}}})(ShaderGraph);
(function(e){e.Outlets=0;e.Outlet=function(a,b,f,h,j,g,m){if("object"==typeof a)return new e.Outlet(a.inout,a.name,a.hint,a.type,a.category,a.exposed,a.meta);this.node=null;this.inout=a;this.name=b;this.hint=f||b;this.type=h;this.category=j;this.exposed=!!g;this.meta=m||{};this.index=++e.Outlets;this.input=this.key=null;this.output=[]};e.Outlet.prototype={id:function(){return["_sg",this.name,this.index].join("_")},expose:function(a){this.exposed=a},morph:function(a){this.inout=a.inout;this.name=a.name;
this.type=a.type;this.category=a.category;this.exposed=a.exposed;this.meta=a.meta||{}},connect:function(a){if(this.inout==e.IN&&a.inout==e.OUT)return a.connect(this);if(this.inout!=e.OUT||a.inout!=e.IN)throw console.log(this,a),"Can't connect out/out or in/in outlets.";a.input!=this&&(a.disconnect(),a.input=this,this.output.push(a))},disconnect:function(a){if(this.inout==e.IN)this.input&&this.input.disconnect(this);else if(a){var b=this.output.indexOf(a);0<=b&&(this.output.splice(b,1),a.input=null)}else _.each(this.output,
function(a){a.input=null}),this.output=[]},link:function(a){this.node=a}}})(ShaderGraph);
