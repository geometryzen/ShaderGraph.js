(function(){function f(d){return function(m,a,l,g){a=A(a,g,4);var q=!v(m)&&b.keys(m),c=(q||m).length,e=0<d?0:c-1;3>arguments.length&&(l=m[q?q[e]:e],e+=d);for(var f=a,h=l;0<=e&&e<c;e+=d)var k=q?q[e]:e,h=f(h,m[k],k,m);return h}}function a(d){return function(m,b,a){b=u(b,a);a=x(m);for(var g=0<d?0:a-1;0<=g&&g<a;g+=d)if(b(m[g],g,m))return g;return-1}}function c(d,m,a){return function(l,g,q){var c=0,e=x(l);if("number"==typeof q)0<d?c=0<=q?q:Math.max(q+e,c):e=0<=q?Math.min(q+1,e):q+e+1;else if(a&&q&&e)return q=
a(l,g),l[q]===g?q:-1;if(g!==g)return q=m(r.call(l,c,e),b.isNaN),0<=q?q+c:-1;for(q=0<d?c:e-1;0<=q&&q<e;q+=d)if(l[q]===g)return q;return-1}}function e(d,m){var a=K.length,l=d.constructor,l=b.isFunction(l)&&l.prototype||t,g="constructor";for(b.has(d,g)&&!b.contains(m,g)&&m.push(g);a--;)g=K[a],g in d&&d[g]!==l[g]&&!b.contains(m,g)&&m.push(g)}var h=this,p=h._,k=Array.prototype,t=Object.prototype,w=k.push,r=k.slice,y=t.toString,Q=t.hasOwnProperty,D=Array.isArray,L=Object.keys,E=Function.prototype.bind,
M=Object.create,F=function(){},b=function(d){if(d instanceof b)return d;if(!(this instanceof b))return new b(d);this._wrapped=d};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=b),exports._=b):h._=b;b.VERSION="1.8.3";var A=function(d,m,b){if(void 0===m)return d;switch(null==b?3:b){case 1:return function(b){return d.call(m,b)};case 2:return function(b,a){return d.call(m,b,a)};case 3:return function(b,a,n){return d.call(m,b,a,n)};case 4:return function(b,
a,n,c){return d.call(m,b,a,n,c)}}return function(){return d.apply(m,arguments)}},u=function(d,m,a){return null==d?b.identity:b.isFunction(d)?A(d,m,a):b.isObject(d)?b.matcher(d):b.property(d)};b.iteratee=function(d,m){return u(d,m,Infinity)};var B=function(d,m){return function(b){var a=arguments.length;if(2>a||null==b)return b;for(var g=1;g<a;g++)for(var c=arguments[g],e=d(c),f=e.length,h=0;h<f;h++){var k=e[h];m&&void 0!==b[k]||(b[k]=c[k])}return b}},N=function(d){if(!b.isObject(d))return{};if(M)return M(d);
F.prototype=d;d=new F;F.prototype=null;return d},C=function(d){return function(m){return null==m?void 0:m[d]}},R=Math.pow(2,53)-1,x=C("length"),v=function(d){d=x(d);return"number"==typeof d&&0<=d&&d<=R};b.each=b.forEach=function(d,m,a){m=A(m,a);var l;if(v(d))for(a=0,l=d.length;a<l;a++)m(d[a],a,d);else{var g=b.keys(d);a=0;for(l=g.length;a<l;a++)m(d[g[a]],g[a],d)}return d};b.map=b.collect=function(d,m,a){m=u(m,a);a=!v(d)&&b.keys(d);for(var l=(a||d).length,g=Array(l),c=0;c<l;c++){var e=a?a[c]:c;g[c]=
m(d[e],e,d)}return g};b.reduce=b.foldl=b.inject=f(1);b.reduceRight=b.foldr=f(-1);b.find=b.detect=function(d,m,a){m=v(d)?b.findIndex(d,m,a):b.findKey(d,m,a);if(void 0!==m&&-1!==m)return d[m]};b.filter=b.select=function(d,m,a){var l=[];m=u(m,a);b.each(d,function(d,b,a){m(d,b,a)&&l.push(d)});return l};b.reject=function(d,m,a){return b.filter(d,b.negate(u(m)),a)};b.every=b.all=function(d,m,a){m=u(m,a);a=!v(d)&&b.keys(d);for(var l=(a||d).length,g=0;g<l;g++){var c=a?a[g]:g;if(!m(d[c],c,d))return!1}return!0};
b.some=b.any=function(d,m,a){m=u(m,a);a=!v(d)&&b.keys(d);for(var l=(a||d).length,g=0;g<l;g++){var c=a?a[g]:g;if(m(d[c],c,d))return!0}return!1};b.contains=b.includes=b.include=function(d,a,n,l){v(d)||(d=b.values(d));if("number"!=typeof n||l)n=0;return 0<=b.indexOf(d,a,n)};b.invoke=function(d,a){var n=r.call(arguments,2),l=b.isFunction(a);return b.map(d,function(d){var b=l?a:d[a];return null==b?b:b.apply(d,n)})};b.pluck=function(d,a){return b.map(d,b.property(a))};b.where=function(d,a){return b.filter(d,
b.matcher(a))};b.findWhere=function(d,a){return b.find(d,b.matcher(a))};b.max=function(d,a,n){var l=-Infinity,g=-Infinity,c;if(null==a&&null!=d){d=v(d)?d:b.values(d);for(var e=0,f=d.length;e<f;e++)n=d[e],n>l&&(l=n)}else a=u(a,n),b.each(d,function(d,b,n){c=a(d,b,n);if(c>g||-Infinity===c&&-Infinity===l)l=d,g=c});return l};b.min=function(d,a,n){var l=Infinity,g=Infinity,c;if(null==a&&null!=d){d=v(d)?d:b.values(d);for(var e=0,f=d.length;e<f;e++)n=d[e],n<l&&(l=n)}else a=u(a,n),b.each(d,function(d,b,n){c=
a(d,b,n);if(c<g||Infinity===c&&Infinity===l)l=d,g=c});return l};b.shuffle=function(d){d=v(d)?d:b.values(d);for(var a=d.length,n=Array(a),l=0,c;l<a;l++)c=b.random(0,l),c!==l&&(n[l]=n[c]),n[c]=d[l];return n};b.sample=function(d,a,n){return null==a||n?(v(d)||(d=b.values(d)),d[b.random(d.length-1)]):b.shuffle(d).slice(0,Math.max(0,a))};b.sortBy=function(d,a,n){a=u(a,n);return b.pluck(b.map(d,function(d,b,n){return{value:d,index:b,criteria:a(d,b,n)}}).sort(function(d,a){var b=d.criteria,m=a.criteria;if(b!==
m){if(b>m||void 0===b)return 1;if(b<m||void 0===m)return-1}return d.index-a.index}),"value")};var G=function(d){return function(a,n,c){var g={};n=u(n,c);b.each(a,function(b,c){var l=n(b,c,a);d(g,b,l)});return g}};b.groupBy=G(function(d,a,n){b.has(d,n)?d[n].push(a):d[n]=[a]});b.indexBy=G(function(d,a,b){d[b]=a});b.countBy=G(function(d,a,n){b.has(d,n)?d[n]++:d[n]=1});b.toArray=function(d){return d?b.isArray(d)?r.call(d):v(d)?b.map(d,b.identity):b.values(d):[]};b.size=function(d){return null==d?0:v(d)?
d.length:b.keys(d).length};b.partition=function(d,a,n){a=u(a,n);var c=[],g=[];b.each(d,function(d,b,n){(a(d,b,n)?c:g).push(d)});return[c,g]};b.first=b.head=b.take=function(d,a,n){return null==d?void 0:null==a||n?d[0]:b.initial(d,d.length-a)};b.initial=function(d,a,b){return r.call(d,0,Math.max(0,d.length-(null==a||b?1:a)))};b.last=function(d,a,n){return null==d?void 0:null==a||n?d[d.length-1]:b.rest(d,Math.max(0,d.length-a))};b.rest=b.tail=b.drop=function(d,a,b){return r.call(d,null==a||b?1:a)};b.compact=
function(d){return b.filter(d,b.identity)};var z=function(d,a,n,c){var g=[],e=0;c=c||0;for(var f=x(d);c<f;c++){var h=d[c];if(v(h)&&(b.isArray(h)||b.isArguments(h))){a||(h=z(h,a,n));var k=0,p=h.length;for(g.length+=p;k<p;)g[e++]=h[k++]}else n||(g[e++]=h)}return g};b.flatten=function(d,a){return z(d,a,!1)};b.without=function(d){return b.difference(d,r.call(arguments,1))};b.uniq=b.unique=function(d,a,c,l){b.isBoolean(a)||(l=c,c=a,a=!1);null!=c&&(c=u(c,l));l=[];for(var g=[],e=0,f=x(d);e<f;e++){var h=
d[e],k=c?c(h,e,d):h;a?(e&&g===k||l.push(h),g=k):c?b.contains(g,k)||(g.push(k),l.push(h)):b.contains(l,h)||l.push(h)}return l};b.union=function(){return b.uniq(z(arguments,!0,!0))};b.intersection=function(d){for(var a=[],c=arguments.length,l=0,g=x(d);l<g;l++){var e=d[l];if(!b.contains(a,e)){for(var f=1;f<c&&b.contains(arguments[f],e);f++);f===c&&a.push(e)}}return a};b.difference=function(d){var a=z(arguments,!0,!0,1);return b.filter(d,function(d){return!b.contains(a,d)})};b.zip=function(){return b.unzip(arguments)};
b.unzip=function(d){for(var a=d&&b.max(d,x).length||0,c=Array(a),l=0;l<a;l++)c[l]=b.pluck(d,l);return c};b.object=function(d,a){for(var b={},c=0,g=x(d);c<g;c++)a?b[d[c]]=a[c]:b[d[c][0]]=d[c][1];return b};b.findIndex=a(1);b.findLastIndex=a(-1);b.sortedIndex=function(d,a,b,c){b=u(b,c,1);a=b(a);c=0;for(var g=x(d);c<g;){var e=Math.floor((c+g)/2);b(d[e])<a?c=e+1:g=e}return c};b.indexOf=c(1,b.findIndex,b.sortedIndex);b.lastIndexOf=c(-1,b.findLastIndex);b.range=function(d,a,b){null==a&&(a=d||0,d=0);b=b||
1;a=Math.max(Math.ceil((a-d)/b),0);for(var c=Array(a),g=0;g<a;g++,d+=b)c[g]=d;return c};var O=function(d,a,c,l,g){if(!(l instanceof a))return d.apply(c,g);a=N(d.prototype);d=d.apply(a,g);return b.isObject(d)?d:a};b.bind=function(d,a){if(E&&d.bind===E)return E.apply(d,r.call(arguments,1));if(!b.isFunction(d))throw new TypeError("Bind must be called on a function");var c=r.call(arguments,2),l=function(){return O(d,l,a,this,c.concat(r.call(arguments)))};return l};b.partial=function(d){var a=r.call(arguments,
1),c=function(){for(var l=0,g=a.length,e=Array(g),f=0;f<g;f++)e[f]=a[f]===b?arguments[l++]:a[f];for(;l<arguments.length;)e.push(arguments[l++]);return O(d,c,this,this,e)};return c};b.bindAll=function(d){var a,c=arguments.length,e;if(1>=c)throw Error("bindAll must be passed function names");for(a=1;a<c;a++)e=arguments[a],d[e]=b.bind(d[e],d);return d};b.memoize=function(d,a){var c=function(e){var g=c.cache,f=""+(a?a.apply(this,arguments):e);b.has(g,f)||(g[f]=d.apply(this,arguments));return g[f]};c.cache=
{};return c};b.delay=function(d,a){var b=r.call(arguments,2);return setTimeout(function(){return d.apply(null,b)},a)};b.defer=b.partial(b.delay,b,1);b.throttle=function(d,a,c){var e,g,f,h=null,k=0;c||(c={});var p=function(){k=!1===c.leading?0:b.now();h=null;f=d.apply(e,g);h||(e=g=null)};return function(){var r=b.now();k||!1!==c.leading||(k=r);var t=a-(r-k);e=this;g=arguments;0>=t||t>a?(h&&(clearTimeout(h),h=null),k=r,f=d.apply(e,g),h||(e=g=null)):h||!1===c.trailing||(h=setTimeout(p,t));return f}};
b.debounce=function(d,a,c){var e,g,f,h,k,p=function(){var r=b.now()-h;r<a&&0<=r?e=setTimeout(p,a-r):(e=null,c||(k=d.apply(f,g),e||(f=g=null)))};return function(){f=this;g=arguments;h=b.now();var r=c&&!e;e||(e=setTimeout(p,a));r&&(k=d.apply(f,g),f=g=null);return k}};b.wrap=function(d,a){return b.partial(a,d)};b.negate=function(d){return function(){return!d.apply(this,arguments)}};b.compose=function(){var d=arguments,a=d.length-1;return function(){for(var b=a,c=d[a].apply(this,arguments);b--;)c=d[b].call(this,
c);return c}};b.after=function(a,b){return function(){if(1>--a)return b.apply(this,arguments)}};b.before=function(a,b){var c;return function(){0<--a&&(c=b.apply(this,arguments));1>=a&&(b=null);return c}};b.once=b.partial(b.before,2);var P=!{toString:null}.propertyIsEnumerable("toString"),K="valueOf isPrototypeOf toString propertyIsEnumerable hasOwnProperty toLocaleString".split(" ");b.keys=function(a){if(!b.isObject(a))return[];if(L)return L(a);var c=[],n;for(n in a)b.has(a,n)&&c.push(n);P&&e(a,c);
return c};b.allKeys=function(a){if(!b.isObject(a))return[];var c=[],n;for(n in a)c.push(n);P&&e(a,c);return c};b.values=function(a){for(var c=b.keys(a),e=c.length,f=Array(e),g=0;g<e;g++)f[g]=a[c[g]];return f};b.mapObject=function(a,c,e){c=u(c,e);e=b.keys(a);for(var f=e.length,g={},h,k=0;k<f;k++)h=e[k],g[h]=c(a[h],h,a);return g};b.pairs=function(a){for(var c=b.keys(a),e=c.length,f=Array(e),g=0;g<e;g++)f[g]=[c[g],a[c[g]]];return f};b.invert=function(a){for(var c={},e=b.keys(a),f=0,g=e.length;f<g;f++)c[a[e[f]]]=
e[f];return c};b.functions=b.methods=function(a){var c=[],e;for(e in a)b.isFunction(a[e])&&c.push(e);return c.sort()};b.extend=B(b.allKeys);b.extendOwn=b.assign=B(b.keys);b.findKey=function(a,c,e){c=u(c,e);e=b.keys(a);for(var f,g=0,h=e.length;g<h;g++)if(f=e[g],c(a[f],f,a))return f};b.pick=function(a,c,e){var f={},g=a,h,k;if(null==g)return f;b.isFunction(c)?(k=b.allKeys(g),h=A(c,e)):(k=z(arguments,!1,!1,1),h=function(a,d,b){return d in b},g=Object(g));for(var r=0,p=k.length;r<p;r++){var t=k[r],y=g[t];
h(y,t,g)&&(f[t]=y)}return f};b.omit=function(a,c,e){if(b.isFunction(c))c=b.negate(c);else{var f=b.map(z(arguments,!1,!1,1),String);c=function(a,d){return!b.contains(f,d)}}return b.pick(a,c,e)};b.defaults=B(b.allKeys,!0);b.create=function(a,c){var e=N(a);c&&b.extendOwn(e,c);return e};b.clone=function(a){return b.isObject(a)?b.isArray(a)?a.slice():b.extend({},a):a};b.tap=function(a,b){b(a);return a};b.isMatch=function(a,c){var e=b.keys(c),f=e.length;if(null==a)return!f;for(var g=Object(a),h=0;h<f;h++){var k=
e[h];if(c[k]!==g[k]||!(k in g))return!1}return!0};var H=function(a,c,e,f){if(a===c)return 0!==a||1/a===1/c;if(null==a||null==c)return a===c;a instanceof b&&(a=a._wrapped);c instanceof b&&(c=c._wrapped);var g=y.call(a);if(g!==y.call(c))return!1;switch(g){case "[object RegExp]":case "[object String]":return""+a===""+c;case "[object Number]":return+a!==+a?+c!==+c:0===+a?1/+a===1/c:+a===+c;case "[object Date]":case "[object Boolean]":return+a===+c}g="[object Array]"===g;if(!g){if("object"!=typeof a||
"object"!=typeof c)return!1;var h=a.constructor,k=c.constructor;if(h!==k&&!(b.isFunction(h)&&h instanceof h&&b.isFunction(k)&&k instanceof k)&&"constructor"in a&&"constructor"in c)return!1}e=e||[];f=f||[];for(h=e.length;h--;)if(e[h]===a)return f[h]===c;e.push(a);f.push(c);if(g){h=a.length;if(h!==c.length)return!1;for(;h--;)if(!H(a[h],c[h],e,f))return!1}else{g=b.keys(a);h=g.length;if(b.keys(c).length!==h)return!1;for(;h--;)if(k=g[h],!b.has(c,k)||!H(a[k],c[k],e,f))return!1}e.pop();f.pop();return!0};
b.isEqual=function(a,b){return H(a,b)};b.isEmpty=function(a){return null==a?!0:v(a)&&(b.isArray(a)||b.isString(a)||b.isArguments(a))?0===a.length:0===b.keys(a).length};b.isElement=function(a){return!(!a||1!==a.nodeType)};b.isArray=D||function(a){return"[object Array]"===y.call(a)};b.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a};b.each("Arguments Function String Number Date RegExp Error".split(" "),function(a){b["is"+a]=function(b){return y.call(b)==="[object "+a+"]"}});
b.isArguments(arguments)||(b.isArguments=function(a){return b.has(a,"callee")});"function"!=typeof/./&&"object"!=typeof Int8Array&&(b.isFunction=function(a){return"function"==typeof a||!1});b.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))};b.isNaN=function(a){return b.isNumber(a)&&a!==+a};b.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"===y.call(a)};b.isNull=function(a){return null===a};b.isUndefined=function(a){return void 0===a};b.has=function(a,b){return null!=a&&
Q.call(a,b)};b.noConflict=function(){h._=p;return this};b.identity=function(a){return a};b.constant=function(a){return function(){return a}};b.noop=function(){};b.property=C;b.propertyOf=function(a){return null==a?function(){}:function(b){return a[b]}};b.matcher=b.matches=function(a){a=b.extendOwn({},a);return function(c){return b.isMatch(c,a)}};b.times=function(a,b,c){var e=Array(Math.max(0,a));b=A(b,c,1);for(c=0;c<a;c++)e[c]=b(c);return e};b.random=function(a,b){null==b&&(b=a,a=0);return a+Math.floor(Math.random()*
(b-a+1))};b.now=Date.now||function(){return(new Date).getTime()};D={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};B=b.invert(D);C=function(a){var c=function(b){return a[b]},e="(?:"+b.keys(a).join("|")+")",f=RegExp(e),g=RegExp(e,"g");return function(a){a=null==a?"":""+a;return f.test(a)?a.replace(g,c):a}};b.escape=C(D);b.unescape=C(B);b.result=function(a,c,e){c=null==a?void 0:a[c];void 0===c&&(c=e);return b.isFunction(c)?c.call(a):c};var S=0;b.uniqueId=function(a){var b=
++S+"";return a?a+b:b};b.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var I=/(.)^/,T={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},U=/\\|'|\r|\n|\u2028|\u2029/g,V=function(a){return"\\"+T[a]};b.template=function(a,c,e){!c&&e&&(c=e);c=b.defaults({},c,b.templateSettings);e=RegExp([(c.escape||I).source,(c.interpolate||I).source,(c.evaluate||I).source].join("|")+"|$","g");var f=0,g="__p+='";a.replace(e,function(b,c,e,
h,k){g+=a.slice(f,k).replace(U,V);f=k+b.length;c?g+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'":e?g+="'+\n((__t=("+e+"))==null?'':__t)+\n'":h&&(g+="';\n"+h+"\n__p+='");return b});g+="';\n";c.variable||(g="with(obj||{}){\n"+g+"}\n");g="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+g+"return __p;\n";try{var h=new Function(c.variable||"obj","_",g)}catch(k){throw k.source=g,k;}e=function(a){return h.call(this,a,b)};e.source="function("+(c.variable||"obj")+
"){\n"+g+"}";return e};b.chain=function(a){a=b(a);a._chain=!0;return a};var J=function(a,c){return a._chain?b(c).chain():c};b.mixin=function(a){b.each(b.functions(a),function(c){var e=b[c]=a[c];b.prototype[c]=function(){var a=[this._wrapped];w.apply(a,arguments);return J(this,e.apply(b,a))}})};b.mixin(b);b.each("pop push reverse shift sort splice unshift".split(" "),function(a){var c=k[a];b.prototype[a]=function(){var b=this._wrapped;c.apply(b,arguments);"shift"!==a&&"splice"!==a||0!==b.length||delete b[0];
return J(this,b)}});b.each(["concat","join","slice"],function(a){var c=k[a];b.prototype[a]=function(){return J(this,c.apply(this._wrapped,arguments))}});b.prototype.value=function(){return this._wrapped};b.prototype.valueOf=b.prototype.toJSON=b.prototype.value;b.prototype.toString=function(){return""+this._wrapped};"function"===typeof define&&define.amd&&define("underscore",[],function(){return b})}).call(this);(function(f){for(var a in f)if(!window[a])throw"Error: ShaderGraph requires "+f[a];})({THREE:"Three.js"});
window.ShaderGraph={};ShaderGraph.getShader=function(f){var a=document.getElementById(f);return a&&(a.innerText||a.textContent)||f};
(function(f){f.Block=function(a){a=a||new f.Node;this.node(a);this.children=[];this.parent=null;this.properties={};this.index=++f.Block.index;this.refresh()};f.Block.index=0;f.Block.prototype={node:function(a){return void 0!==a?(this._node=a,this):this._node},refresh:function(){this._node.owner(this);this._node.outlets(this.outlets())},fetch:function(a,c,e,f){},id:function(a,c,e,h){if(e.meta.inout){var p=e.node.get(e.name,f.IN).input;if(p)return p.node.owner().fetch(a,c,p,h+1)}return e.id()}};f.Block.Snippet=
function(a){this.snippet=new f.Snippet(a);f.Block.call(this)};f.Block.Snippet.prototype=_.extend({},f.Block.prototype,{insert:function(a,c,e){f.Block.Snippet.compileCall(a,c,this.node(),this.snippet,e)},fetch:function(a,c,e,f){a.include(this,c)||this.insert(a,c,f);return this.id(a,c,e,f)},outlets:function(){return f.Block.Snippet.makeOutlets(this.snippet)}});f.Block.Material=function(a,c){this.vertex=new f.Snippet(a);this.fragment=new f.Snippet(c);f.Block.call(this)};f.Block.Material.prototype=_.extend({},
f.Block.prototype,{compile:function(){if(0<this.node().outputs.length)throw"Can't compile material with outputs";this.node();var a=new f.Program;this.insert(a,"vertex",0);this.insert(a,"fragment",0);a.compile();return a},insert:function(a,c,e){f.Block.Snippet.compileCall(a,c,this.node(),this[c],e)},fetch:function(a,c,e,f){a.include(this,c)||this.insert(a,c,f);"fragment"==c&&(a.include(this,"vertex")||this.insert(a,"vertex",0));return this.id(a,c,e,f)},outlets:function(){var a=f.Block.Snippet.makeOutlets(this.vertex),
c=f.Block.Snippet.makeOutlets(this.fragment);return _.union(a,c)}});f.Block.Snippet.makeOutlets=function(a){var c=[];if(a.outlets)return a.outlets;var e=a.arguments();_.each(e.parameters,function(a){a=_.extend({},a);a.meta={required:!0};a.hint=a.name.replace(/(In|Out)$/,"");a.category="parameter";if(a.inout==f.INOUT){a.meta.inout=!0;var e=_.extend({},a);e.inout=f.IN;c.push(e);a.inout=f.OUT}c.push(a)});_.each(e.uniforms,function(a){a.meta={};a.hint=a.name.replace(/(In|Out)$/,"");a.category="uniform";
a.inout=f.IN;c.push(a)});return a.outlets=c};f.Block.Snippet.compileCall=function(a,c,e,h,p){var k=h.arguments(),t=[];_.each(k.parameters,function(h){var k=e.get(h.name,h.inout==f.INOUT?f.IN:h.inout);if(h.inout==f.IN||h.inout==f.INOUT)if(k.input)k=k.input.node.owner().fetch(a,c,k.input,p+1),a.variable(c,k,h),t.push(k);else throw console.log("Outlet",h,input),["Missing connection on outlet for "+h.name];else h.inout==f.OUT&&(k=k.id(),a.variable(c,k,h),t.push(k))});var w=[];_.each(k.uniforms,function(f){var h=
e.get(f.name);h.input?(h=h.input.node.owner().fetch(a,c,h.input,p+1),a.variable(c,h,f),t.push(h),w.push(f.name)):a.external("uniform",f)});_.each(k.attributes,function(c){a.external("attribute",c)});_.each(k.varyings,function(c){a.external("varying",c)});k=["_sg",c,h.name,e.owner().index].join("_");h=h.compile(k,w,!0);a.add(c,k,t,h,p)}})(ShaderGraph);
(function(f){f.Factory=function(){this.end()};f.Factory.prototype={snippet:function(a,c){c=c||"append";var e=new f.Block.Snippet(ShaderGraph.getShader(a));this[c](e.node());return this},material:function(a,c,e){e=e||"append";a=new f.Block.Material(ShaderGraph.getShader(a),ShaderGraph.getShader(c));this[e](a.node());return this},snippetBefore:function(a){this.snippet(a,"prepend");return this},materialBefore:function(a,c){this.material(code,"prepend");return this},append:function(a){a.graph||this.graph.add(a);
var c=this.stack[0];_.each(c.end,function(c){c.connect(a)});c.start.length||(c.start=[a]);c.end=[a];return this},prepend:function(a){a.graph||this.graph.add(a);var c=this.stack[0];_.each(c.start,function(c){a.connect(c)});c.end.length||(c.end=[a]);c.start=[a];return this},group:function(){this.stack.unshift({start:[],end:[]});this.stack.unshift({start:[],end:[]});return this},pass:function(){this.next();this.stack[0].start.push(null);return this.combine()},next:function(){var a=this.stack.shift(),
c=this.stack[0];c.start=c.start.concat(a.start);c.end=c.end.concat(a.end);this.stack.unshift({start:[],end:[]});return this},combine:function(){if(2>=this.stack.length)throw"Popping factory stack too far.";this.next();this.stack.shift();var a=this.stack.shift(),c=this.stack[0];a.start.length&&(_.each(a.start,function(e){e?_.each(c.end,function(a){a.connect(e,!0)}):a.end=a.end.concat(c.end)}),c.end=a.end);return this},end:function(){var a=this.graph;this.graph=new f.Graph;this.stack=[];this.group();
a&&(a.compile=function(){return a.tail().owner().compile()});return a}}})(ShaderGraph);
(function(f){f.Program=function(){this.calls={vertex:{},fragment:{}};this.variables={vertex:{},fragment:{}};this.externals={};this.compiled=!1;this.attributes={};this.uniforms={};this.fragmentShader=this.vertexShader="";this.includes={vertex:[],fragment:[]}};f.Program.types={f:"float",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4",t:"sampler2D"};f.Program.prototype={include:function(a,c){if(0<=this.includes[c].indexOf(a))return!0;this.includes[c].push(a);return!1},external:function(a,c){c=_.extend({category:a},
c);this.externals[c.name]=c},variable:function(a,c,e){e=_.extend({},e,{name:c});this.variables[a][c]=e},add:function(a,c,e,f,p){var k=this.calls[a][c];k?k.priority=Math.min(k.priority,p):this.calls[a][c]={name:c,args:e,code:f,priority:p}},compile:function(){_.each(this.externals,function(a){"uniform"==a.category&&(this.uniforms[a.name]={type:a.type,value:a.value});"attribute"==a.category&&(this.attributes[a.name]={type:a.type,value:[]})}.bind(this));_.each(["vertex","fragment"],function(a){var c=
[];_.each(this.externals,function(e){"attribute"==e.category&&"fragment"==a||c.push([e.category,e.signature,";"].join(" "))}.bind(this));var c=c.join("\n"),e=_.toArray(this.calls[a]),h=[c],p=["void main() {"];_.each(this.variables[a],function(a){p.push([f.Program.types[a.type],a.name,";"].join(" "))});e.sort(function(a,c){return c.priority-a.priority});_.each(e,function(a){h.push(a.code);p.push([a.name,"(",a.args.join(","),");"].join(""))});p.push("}");this[a+"Shader"]=[h.join("\n"),p.join("\n")].join("\n")}.bind(this));
this.compiled=!0},material:function(){if(!this.compiled)throw"Fetching material from uncompiled program.";return new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:this.vertex,fragmentShader:this.fragment})}}})(ShaderGraph);
(function(f){f.Snippet=function(a){if(f.Snippet.cache[a])return f.Snippet.cache[a];f.Snippet.cache[a]=this;this.code=a;this.attributes=[];this.uniforms=[];this.varyings=[];this.parameters=[];this.body=this.signature="";this.parseCode(a)};f.Snippet.cache={};f.Snippet.types={"float":"f",vec2:"v2",vec3:"v3",vec4:"v4",mat3:"m3",mat4:"m4",sampler2D:"t",samplerCube:"t"};f.Snippet.defaults={"float":0,vec2:new THREE.Vector3,vec3:new THREE.Vector3,vec4:new THREE.Vector4,mat4:new THREE.Matrix4,sampler2D:0,
samplerCube:0};f.Snippet.prototype={compile:function(a,c,e){var f=this.signature.slice(),p=[];c=c||[];_.each(this.uniforms,function(a){0<=c.indexOf(a.name)?f.push(a.signature):e||p.push(["uniform",a.signature].join(" "))});!e&&_.each(this.attributes,function(a){p.push(["attribute",a.signature].join(" "))});!e&&_.each(this.varyings,function(a){p.push(["varying",a.signature].join(" "))});a=this.body.replace(/\s*void\s+([A-Za-z0-9]+)\s*\([^\)]*\)/g,["void",a+"(",f.join(", "),")"].join(" "));p.push(a);
return p.join(";\n")},arguments:function(){return{uniforms:this.uniforms,varyings:this.varyings,attributes:this.attributes,parameters:this.parameters}},type:function(a,c){a=(f.Snippet.types[a]||"f")+(c?"v":"");return"fv"==a?"fv1":a},parseAttribute:function(a){var c=a[1];this.attributes.push({name:a[3],type:this.type(a[2],a[4]),signature:c})},parseUniform:function(a){var c=a[1],e=a[2];this.uniforms.push({name:a[3],type:this.type(e,a[4]),value:f.Snippet.defaults[e]||0,signature:c})},parseVarying:function(a){var c=
a[1];this.varyings.push({name:a[3],type:this.type(a[2],a[4]),signature:c})},parseSignature:function(a){this.name=a[1];var c=a[2].replace(/^\s*$/g,"");0==c.length?this.signature=[]:(arguments=this.signature=c.split(","),_.each(arguments,function(a){a=/((?:(in|out|inout)\s+)?([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/.exec(a);var c=a[1];this.parameters.push({inout:{"in":f.IN,out:f.OUT,inout:f.INOUT}[a[2]||"in"],name:a[4],type:this.type(a[3],a[5]),signature:c})}.bind(this)))},parseCode:function(a){function c(a,
c){if(!a.global)throw"Can't findAll non-global regexp";for(var e,f=[];e=a.exec(c);)f.push(e);return f}a=a.replace(/\r\n?/g,"\n").replace(/\/\/[^\n]*\n/g," ").replace(/\/\*(.|\n)*?\*\//g," ");var e=c(/(?:^|;)\s*attribute\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),f=c(/(?:^|;)\s*uniform\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),p=c(/(?:^|;)\s*varying\s+(([A-Za-z0-9]+)\s+([[A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),k=c(/(?:^|;)\s*void\s+([A-Za-z0-9]+)\s*\(([^\)]*)\)\s*{/g,
a);if(!k[0])throw"Could not parse shader snippet. Must contain a void-returning function with in/outs: "+a;var t=a;_.each({parseAttribute:e,parseUniform:f,parseVarying:p},function(a,c){_.each(a,function(a){this[c](a);t=t.replace(a[0],"")}.bind(this))}.bind(this));t=t.replace(/^\s*;/,"");this.parseSignature(k[0]);this.body=t}}})(ShaderGraph);
(function(f){f.Graph=function(a,c){this.parent=c||null;this.nodes=[];a&&this.add(a)};f.Graph.prototype={iterate:function(a){_.each(this.nodes,function(c){a(c,c._owner)})},exposed:function(){var a=[];this.iterate(function(c){_.each(c.outlets(),function(c){c.exposed&&a.push(c)})});return a},inputs:function(){var a=[];this.iterate(function(c){_.each(c.inputs,function(c){null==c.input&&a.push(c)})});return a},outputs:function(){var a=[];this.iterate(function(c){_.each(c.outputs,function(c){0==c.output.length&&
a.push(c)})});return a},tail:function(){return this.nodes[this.nodes.length-1]},add:function(a){if(a.constructor==Array)return _.each(a,function(a){this.add(a)}.bind(this));if(a.graph)throw"Adding node to two graphs at once";a.link(this);this.nodes.push(a)},remove:function(a,c){var e=this;if(a.constructor==Array)return _.each(a,function(a){e.remove(a)});if(a.graph!=this)throw"Removing node from wrong graph.";c||a.disconnect();this.nodes.splice(this.nodes.indexOf(a),1)}};f.IN=0;f.OUT=1;f.INOUT=2})(ShaderGraph);
(function(f){f.Node=function(a,c){this.graph=null;this.inputs=[];this.outputs=[];this._outlets={};this.owner(a);this.outlets(c)};f.Node.prototype={owner:function(a){return void 0!==a?(this._owner=a,this):this._owner},link:function(a){this.graph=a},getIn:function(a){return this.get(a,f.IN)},getOut:function(a){return this.get(a,f.OUT)},get:function(a,c){return void 0===c?this.get(a,f.IN)||this.get(a,f.OUT):this._outlets[[a,c].join("-")]},key:function(a){return[a.name,a.inout].join("-")},outlets:function(a){if(void 0!==
a){var c={};_.each(a,function(a){c[[a.name,a.inout,a.type].join("-")]=!0}.bind(this));_.each(this._outlets,function(a){c[[a.name,a.inout,a.type].join("-")]||this.remove(a)}.bind(this));_.each(a,function(a){var c=this.get(a.name,a.inout);c?c.morph(a):(a=new f.Outlet(a),this.add(a))}.bind(this));return this}return this._outlets},add:function(a){var c=this.key(a);outlets=this._outlets;_in=this.inputs;_out=this.outputs;if(a.node)throw"Adding outlet to two nodes at once.";if(outlets[c])throw"Adding two identical outlets to same node.";
a.link(this);outlets[c]=a;(a.inout==f.IN?_in:_out).push(a);return this},remove:function(a){var c=this._outlets,e=this.key(a),h=a.inout==f.IN?this.inputs:this.outputs;if(a.node!=this)throw"Removing outlet from wrong node.";a.disconnect();a.link(null);delete c[e];h.splice(h.indexOf(a),1);return this},connect:function(a,c,e){var f={},p={};_.each(a.inputs,function(a){if(e||!a.input){var c=a.type,w=[c,a.hint].join("-");p[w]||(p[w]=a);f[c]=f[c]||[];f[c].push(a)}});_.each(this.outputs,function(a){if(!c||
!a.output.length){var e=a.type,w=[e,a.hint].join("-");p[w]?(p[w].connect(a),delete p[w],f[e].splice(f[e].indexOf(a),1)):f[e]&&f[e].length&&f[e].shift().connect(a)}});return this},disconnect:function(a){_.each(this.inputs,function(a){a.disconnect()});_.each(this.outputs,function(a){a.disconnect()});return this}}})(ShaderGraph);
(function(f){f.Outlets=0;f.Outlet=function(a,c,e,h,p,k,t){if("object"==typeof a)return new f.Outlet(a.inout,a.name,a.hint,a.type,a.category,a.exposed,a.meta);this.node=null;this.inout=a;this.name=c;this.hint=e||c;this.type=h;this.category=p;this.exposed=!!k;this.meta=t||{};this.index=++f.Outlets;this.input=this.key=null;this.output=[]};f.Outlet.prototype={id:function(){return["_sg",this.name,this.index].join("_")},expose:function(a){this.exposed=a},morph:function(a){this.inout=a.inout;this.name=a.name;
this.type=a.type;this.category=a.category;this.exposed=a.exposed;this.meta=a.meta||{}},connect:function(a){if(this.inout==f.IN&&a.inout==f.OUT)return a.connect(this);if(this.inout!=f.OUT||a.inout!=f.IN)throw console.log(this,a),"Can't connect out/out or in/in outlets.";a.input!=this&&(a.disconnect(),a.input=this,this.output.push(a))},disconnect:function(a){if(this.inout==f.IN)this.input&&this.input.disconnect(this);else if(a){var c=this.output.indexOf(a);0<=c&&(this.output.splice(c,1),a.input=null)}else _.each(this.output,
function(a){a.input=null}),this.output=[]},link:function(a){this.node=a}}})(ShaderGraph);
