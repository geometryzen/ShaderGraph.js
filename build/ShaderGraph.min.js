(function(){function f(d,a,j){if(d===a)return 0!==d||1/d==1/a;if(null==d||null==a)return d===a;d._chain&&(d=d._wrapped);a._chain&&(a=a._wrapped);if(d.isEqual&&c.isFunction(d.isEqual))return d.isEqual(a);if(a.isEqual&&c.isFunction(a.isEqual))return a.isEqual(d);var b=k.call(d);if(b!=k.call(a))return!1;switch(b){case "[object String]":return d==""+a;case "[object Number]":return d!=+d?a!=+a:0==d?1/d==1/a:d==+a;case "[object Date]":case "[object Boolean]":return+d==+a;case "[object RegExp]":return d.source==
a.source&&d.global==a.global&&d.multiline==a.multiline&&d.ignoreCase==a.ignoreCase}if("object"!=typeof d||"object"!=typeof a)return!1;for(var e=j.length;e--;)if(j[e]==d)return!0;j.push(d);var e=0,g=!0;if("[object Array]"==b){if(e=d.length,g=e==a.length)for(;e--&&(g=e in d==e in a&&f(d[e],a[e],j)););}else{if("constructor"in d!="constructor"in a||d.constructor!=a.constructor)return!1;for(var h in d)if(c.has(d,h)&&(e++,!(g=c.has(a,h)&&f(d[h],a[h],j))))break;if(g){for(h in a)if(c.has(a,h)&&!e--)break;
g=!e}}j.pop();return g}var a=this,b=a._,e={},h=Array.prototype,i=Object.prototype,g=h.slice,l=h.unshift,k=i.toString,G=i.hasOwnProperty,p=h.forEach,x=h.map,y=h.reduce,z=h.reduceRight,A=h.filter,B=h.every,C=h.some,r=h.indexOf,D=h.lastIndexOf,i=Array.isArray,H=Object.keys,s=Function.prototype.bind,c=function(d){return new n(d)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports._=c):a._=c;c.VERSION="1.3.3";var m=c.each=c.forEach=function(d,
a,j){if(null!=d)if(p&&d.forEach===p)d.forEach(a,j);else if(d.length===+d.length)for(var b=0,f=d.length;b<f&&!(b in d&&a.call(j,d[b],b,d)===e);b++);else for(b in d)if(c.has(d,b)&&a.call(j,d[b],b,d)===e)break};c.map=c.collect=function(d,a,c){var b=[];if(null==d)return b;if(x&&d.map===x)return d.map(a,c);m(d,function(d,e,f){b[b.length]=a.call(c,d,e,f)});d.length===+d.length&&(b.length=d.length);return b};c.reduce=c.foldl=c.inject=function(d,a,j,b){var e=2<arguments.length;null==d&&(d=[]);if(y&&d.reduce===
y)return b&&(a=c.bind(a,b)),e?d.reduce(a,j):d.reduce(a);m(d,function(d,c,f){e?j=a.call(b,j,d,c,f):(j=d,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return j};c.reduceRight=c.foldr=function(d,a,j,b){var e=2<arguments.length;null==d&&(d=[]);if(z&&d.reduceRight===z)return b&&(a=c.bind(a,b)),e?d.reduceRight(a,j):d.reduceRight(a);var f=c.toArray(d).reverse();b&&!e&&(a=c.bind(a,b));return e?c.reduce(f,a,j,b):c.reduce(f,a)};c.find=c.detect=function(d,a,c){var b;E(d,function(d,
e,f){if(a.call(c,d,e,f))return b=d,!0});return b};c.filter=c.select=function(d,a,c){var b=[];if(null==d)return b;if(A&&d.filter===A)return d.filter(a,c);m(d,function(d,e,f){a.call(c,d,e,f)&&(b[b.length]=d)});return b};c.reject=function(d,a,c){var b=[];if(null==d)return b;m(d,function(d,e,f){a.call(c,d,e,f)||(b[b.length]=d)});return b};c.every=c.all=function(d,a,c){var b=!0;if(null==d)return b;if(B&&d.every===B)return d.every(a,c);m(d,function(d,f,g){if(!(b=b&&a.call(c,d,f,g)))return e});return!!b};
var E=c.some=c.any=function(d,a,b){a||(a=c.identity);var f=!1;if(null==d)return f;if(C&&d.some===C)return d.some(a,b);m(d,function(d,c,g){if(f||(f=a.call(b,d,c,g)))return e});return!!f};c.include=c.contains=function(d,a){return null==d?!1:r&&d.indexOf===r?-1!=d.indexOf(a):E(d,function(d){return d===a})};c.invoke=function(d,a){var b=g.call(arguments,2);return c.map(d,function(d){return(c.isFunction(a)?a||d:d[a]).apply(d,b)})};c.pluck=function(d,a){return c.map(d,function(d){return d[a]})};c.max=function(d,
a,b){if(!a&&c.isArray(d)&&d[0]===+d[0])return Math.max.apply(Math,d);if(!a&&c.isEmpty(d))return-Infinity;var e={computed:-Infinity};m(d,function(d,c,f){c=a?a.call(b,d,c,f):d;c>=e.computed&&(e={value:d,computed:c})});return e.value};c.min=function(d,a,b){if(!a&&c.isArray(d)&&d[0]===+d[0])return Math.min.apply(Math,d);if(!a&&c.isEmpty(d))return Infinity;var e={computed:Infinity};m(d,function(d,c,f){c=a?a.call(b,d,c,f):d;c<e.computed&&(e={value:d,computed:c})});return e.value};c.shuffle=function(d){var a=
[],c;m(d,function(d,b){c=Math.floor(Math.random()*(b+1));a[b]=a[c];a[c]=d});return a};c.sortBy=function(d,a,b){var e=c.isFunction(a)?a:function(d){return d[a]};return c.pluck(c.map(d,function(d,a,c){return{value:d,criteria:e.call(b,d,a,c)}}).sort(function(d,a){var c=d.criteria,b=a.criteria;return void 0===c?1:void 0===b?-1:c<b?-1:c>b?1:0}),"value")};c.groupBy=function(d,a){var b={},e=c.isFunction(a)?a:function(d){return d[a]};m(d,function(d,a){var c=e(d,a);(b[c]||(b[c]=[])).push(d)});return b};c.sortedIndex=
function(d,a,b){b||(b=c.identity);for(var e=0,f=d.length;e<f;){var g=e+f>>1;b(d[g])<b(a)?e=g+1:f=g}return e};c.toArray=function(d){return!d?[]:c.isArray(d)||c.isArguments(d)?g.call(d):d.toArray&&c.isFunction(d.toArray)?d.toArray():c.values(d)};c.size=function(d){return c.isArray(d)?d.length:c.keys(d).length};c.first=c.head=c.take=function(d,a,c){return null!=a&&!c?g.call(d,0,a):d[0]};c.initial=function(d,a,c){return g.call(d,0,d.length-(null==a||c?1:a))};c.last=function(d,a,c){return null!=a&&!c?
g.call(d,Math.max(d.length-a,0)):d[d.length-1]};c.rest=c.tail=function(d,a,c){return g.call(d,null==a||c?1:a)};c.compact=function(d){return c.filter(d,function(d){return!!d})};c.flatten=function(d,a){return c.reduce(d,function(d,b){if(c.isArray(b))return d.concat(a?b:c.flatten(b));d[d.length]=b;return d},[])};c.without=function(d){return c.difference(d,g.call(arguments,1))};c.uniq=c.unique=function(d,a,b){var b=b?c.map(d,b):d,e=[];3>d.length&&(a=!0);c.reduce(b,function(b,f,j){if(a?c.last(b)!==f||
!b.length:!c.include(b,f))b.push(f),e.push(d[j]);return b},[]);return e};c.union=function(){return c.uniq(c.flatten(arguments,!0))};c.intersection=c.intersect=function(d){var a=g.call(arguments,1);return c.filter(c.uniq(d),function(d){return c.every(a,function(a){return 0<=c.indexOf(a,d)})})};c.difference=function(d){var a=c.flatten(g.call(arguments,1),!0);return c.filter(d,function(d){return!c.include(a,d)})};c.zip=function(){for(var d=g.call(arguments),a=c.max(c.pluck(d,"length")),b=Array(a),e=
0;e<a;e++)b[e]=c.pluck(d,""+e);return b};c.indexOf=function(d,a,b){if(null==d)return-1;var e;if(b)return b=c.sortedIndex(d,a),d[b]===a?b:-1;if(r&&d.indexOf===r)return d.indexOf(a);b=0;for(e=d.length;b<e;b++)if(b in d&&d[b]===a)return b;return-1};c.lastIndexOf=function(d,a){if(null==d)return-1;if(D&&d.lastIndexOf===D)return d.lastIndexOf(a);for(var c=d.length;c--;)if(c in d&&d[c]===a)return c;return-1};c.range=function(d,a,c){1>=arguments.length&&(a=d||0,d=0);for(var c=arguments[2]||1,b=Math.max(Math.ceil((a-
d)/c),0),e=0,f=Array(b);e<b;)f[e++]=d,d+=c;return f};var F=function(){};c.bind=function(d,a){var b,e;if(d.bind===s&&s)return s.apply(d,g.call(arguments,1));if(!c.isFunction(d))throw new TypeError;e=g.call(arguments,2);return b=function(){if(!(this instanceof b))return d.apply(a,e.concat(g.call(arguments)));F.prototype=d.prototype;var c=new F,f=d.apply(c,e.concat(g.call(arguments)));return Object(f)===f?f:c}};c.bindAll=function(d){var a=g.call(arguments,1);0==a.length&&(a=c.functions(d));m(a,function(a){d[a]=
c.bind(d[a],d)});return d};c.memoize=function(a,b){var e={};b||(b=c.identity);return function(){var f=b.apply(this,arguments);return c.has(e,f)?e[f]:e[f]=a.apply(this,arguments)}};c.delay=function(a,c){var b=g.call(arguments,2);return setTimeout(function(){return a.apply(null,b)},c)};c.defer=function(a){return c.delay.apply(c,[a,1].concat(g.call(arguments,1)))};c.throttle=function(a,b){var e,f,g,h,i,l,p=c.debounce(function(){i=h=!1},b);return function(){e=this;f=arguments;g||(g=setTimeout(function(){g=
null;i&&a.apply(e,f);p()},b));h?i=!0:l=a.apply(e,f);p();h=!0;return l}};c.debounce=function(a,c,b){var e;return function(){var f=this,g=arguments;b&&!e&&a.apply(f,g);clearTimeout(e);e=setTimeout(function(){e=null;b||a.apply(f,g)},c)}};c.once=function(a){var c=!1,b;return function(){if(c)return b;c=!0;return b=a.apply(this,arguments)}};c.wrap=function(a,c){return function(){var b=[a].concat(g.call(arguments,0));return c.apply(this,b)}};c.compose=function(){var a=arguments;return function(){for(var c=
arguments,b=a.length-1;0<=b;b--)c=[a[b].apply(this,c)];return c[0]}};c.after=function(a,c){return 0>=a?c():function(){if(1>--a)return c.apply(this,arguments)}};c.keys=H||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],e;for(e in a)c.has(a,e)&&(b[b.length]=e);return b};c.values=function(a){return c.map(a,c.identity)};c.functions=c.methods=function(a){var b=[],e;for(e in a)c.isFunction(a[e])&&b.push(e);return b.sort()};c.extend=function(a){m(g.call(arguments,1),function(b){for(var c in b)a[c]=
b[c]});return a};c.pick=function(a){var b={};m(c.flatten(g.call(arguments,1)),function(c){c in a&&(b[c]=a[c])});return b};c.defaults=function(a){m(g.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])});return a};c.clone=function(a){return!c.isObject(a)?a:c.isArray(a)?a.slice():c.extend({},a)};c.tap=function(a,c){c(a);return a};c.isEqual=function(a,c){return f(a,c,[])};c.isEmpty=function(a){if(null==a)return!0;if(c.isArray(a)||c.isString(a))return 0===a.length;for(var b in a)if(c.has(a,
b))return!1;return!0};c.isElement=function(a){return!!(a&&1==a.nodeType)};c.isArray=i||function(a){return"[object Array]"==k.call(a)};c.isObject=function(a){return a===Object(a)};c.isArguments=function(a){return"[object Arguments]"==k.call(a)};c.isArguments(arguments)||(c.isArguments=function(a){return!(!a||!c.has(a,"callee"))});c.isFunction=function(a){return"[object Function]"==k.call(a)};c.isString=function(a){return"[object String]"==k.call(a)};c.isNumber=function(a){return"[object Number]"==
k.call(a)};c.isFinite=function(a){return c.isNumber(a)&&isFinite(a)};c.isNaN=function(a){return a!==a};c.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==k.call(a)};c.isDate=function(a){return"[object Date]"==k.call(a)};c.isRegExp=function(a){return"[object RegExp]"==k.call(a)};c.isNull=function(a){return null===a};c.isUndefined=function(a){return void 0===a};c.has=function(a,c){return G.call(a,c)};c.noConflict=function(){a._=b;return this};c.identity=function(a){return a};c.times=
function(a,c,b){for(var e=0;e<a;e++)c.call(b,e)};c.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};c.result=function(a,b){if(null==a)return null;var e=a[b];return c.isFunction(e)?e.call(a):e};c.mixin=function(a){m(c.functions(a),function(b){var e=c[b]=a[b];n.prototype[b]=function(){var a=g.call(arguments);l.call(a,this._wrapped);return t(e.apply(c,a),this._chain)}})};var I=0;c.uniqueId=
function(a){var b=I++;return a?a+b:b};c.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var u=/.^/,q={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"},v;for(v in q)q[q[v]]=v;var J=/\\|'|\r|\n|\t|\u2028|\u2029/g,K=/\\(\\|'|r|n|t|u2028|u2029)/g,w=function(a){return a.replace(K,function(a,b){return q[b]})};c.template=function(a,b,e){e=c.defaults(e||{},c.templateSettings);a="__p+='"+a.replace(J,function(a){return"\\"+q[a]}).replace(e.escape||
u,function(a,b){return"'+\n_.escape("+w(b)+")+\n'"}).replace(e.interpolate||u,function(a,b){return"'+\n("+w(b)+")+\n'"}).replace(e.evaluate||u,function(a,b){return"';\n"+w(b)+"\n;__p+='"})+"';\n";e.variable||(a="with(obj||{}){\n"+a+"}\n");var a="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+a+"return __p;\n",f=new Function(e.variable||"obj","_",a);if(b)return f(b,c);b=function(a){return f.call(this,a,c)};b.source="function("+(e.variable||"obj")+"){\n"+a+"}";return b};
c.chain=function(a){return c(a).chain()};var n=function(a){this._wrapped=a};c.prototype=n.prototype;var t=function(a,b){return b?c(a).chain():a};c.mixin(c);m("pop push reverse shift sort splice unshift".split(" "),function(a){var b=h[a];n.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var e=c.length;("shift"==a||"splice"==a)&&0===e&&delete c[0];return t(c,this._chain)}});m(["concat","join","slice"],function(a){var b=h[a];n.prototype[a]=function(){return t(b.apply(this._wrapped,arguments),
this._chain)}});n.prototype.chain=function(){this._chain=!0;return this};n.prototype.value=function(){return this._wrapped}}).call(this);(function(f){for(var a in f)if(!window[a])throw"Error: ShaderGraph requires "+f[a];})({THREE:"Three.js"});window.ShaderGraph={};ShaderGraph.getShader=function(f){var a=document.getElementById(f);return a&&(a.innerText||a.textContent)||f};
(function(f){f.Block=function(a){a=a||new f.Node;this.node(a);this.children=[];this.parent=null;this.properties={};this.index=++f.Block.index;this.refresh()};f.Block.index=0;f.Block.prototype={node:function(a){return void 0!==a?(this._node=a,this):this._node},refresh:function(){this._node.owner(this);this._node.outlets(this.outlets())},fetch:function(){}};f.Block.Snippet=function(a){this.snippet=new f.Snippet(a);f.Block.call(this)};f.Block.Snippet.prototype=_.extend({},f.Block.prototype,{insert:function(a,
b,e){f.Block.Snippet.compileCall(a,b,this.node(),this.snippet,e)},fetch:function(a,b,e,f){a.include(this,b)||this.insert(a,b,f);return e.id()},outlets:function(){return f.Block.Snippet.makeOutlets(this.snippet)}});f.Block.Material=function(a,b){this.vertex=new f.Snippet(a);this.fragment=new f.Snippet(b);f.Block.call(this)};f.Block.Material.prototype=_.extend({},f.Block.prototype,{compile:function(){if(0<this.node().outputs.length)throw"Can't compile material with outputs";this.node();var a=new f.Program;
this.insert(a,"vertex",0);this.insert(a,"fragment",0);a.compile();return a},insert:function(a,b,e){f.Block.Snippet.compileCall(a,b,this.node(),this[b],e)},fetch:function(a,b,e,f){a.include(this,b)||this.insert(a,b,f);"fragment"==b&&(a.include(this,"vertex")||this.insert(a,"vertex",0));return e.id()},outlets:function(){var a=f.Block.Snippet.makeOutlets(this.vertex),b=f.Block.Snippet.makeOutlets(this.fragment);return _.union(a,b)}});f.Block.Snippet.makeOutlets=function(a){var b=[];if(a.outlets)return a.outlets;
var e=a.arguments();_.each(e.parameters,function(a){a.meta={required:!0};a.hint=a.name.replace(/(In|Out)$/,"");a.category="parameter";b.push(a)});_.each(e.uniforms,function(a){a.meta={};a.hint=a.name.replace(/(In|Out)$/,"");a.category="uniform";a.inout=f.IN;b.push(a)});return a.outlets=b};f.Block.Snippet.compileCall=function(a,b,e,h,i){var g=h.arguments(),l=[];_.each(g.parameters,function(g){var h=e.get(g.name);if(g.inout==f.IN)if(h.input)h=h.input.node.owner().fetch(a,b,h.input,i+1),a.variable(b,
h,g),l.push(h);else throw console.log("Outlet",g,h),["Missing connection on outlet for "+g.name];else g.inout==f.OUT&&(h=h.id(),a.variable(b,h,g),l.push(h))});var k=[];_.each(g.uniforms,function(f){var g=e.get(f.name);g.input?(g=g.input.node.owner().fetch(a,b,g.input,i+1),a.variable(b,g,f),l.push(g),k.push(f.name)):a.external("uniform",f)});_.each(g.attributes,function(b){a.external("attribute",b)});_.each(g.varyings,function(b){a.external("varying",b)});g=["_sg",b,h.name,e.owner().index].join("_");
h=h.compile(g,k,!0);a.add(b,g,l,h,i)}})(ShaderGraph);
(function(f){f.Factory=function(){this.end()};f.Factory.prototype={snippet:function(a,b){var b=b||"append",e=new f.Block.Snippet(ShaderGraph.getShader(a));this[b](e.node());return this},material:function(a,b,e){e=e||"append";a=new f.Block.Material(ShaderGraph.getShader(a),ShaderGraph.getShader(b));this[e](a.node());return this},snippetBefore:function(a){this.snippet(a,"prepend");return this},materialBefore:function(){this.material(code,"prepend");return this},append:function(a){a.graph||this.graph.add(a);
var b=this.stack[0];_.each(b.end,function(b){b.connect(a)});b.start.length||(b.start=[a]);b.end=[a];return this},prepend:function(a){a.graph||this.graph.add(a);var b=this.stack[0];_.each(b.start,function(b){a.connect(b)});b.end.length||(b.end=[a]);b.start=[a];return this},group:function(){this.stack.unshift({start:[],end:[]});this.stack.unshift({start:[],end:[]});return this},next:function(){var a=this.stack.shift(),b=this.stack[0];b.start=b.start.concat(a.start);b.end=b.end.concat(a.end);this.stack.unshift({start:[],
end:[]});return this},combine:function(){if(2>=this.stack.length)throw"Popping factory stack too far.";this.next();this.stack.shift();var a=this.stack.shift(),b=this.stack[0];_.each(a.start,function(a){_.each(b.end,function(b){b.connect(a,!0)})});b.end=a.end;return this},end:function(){var a=this.graph;this.graph=new f.Graph;this.stack=[];this.group();a&&(a.compile=function(){return a.tail().owner().compile()});return a}}})(ShaderGraph);
(function(f){f.Program=function(){this.calls={vertex:{},fragment:{}};this.variables={vertex:{},fragment:{}};this.externals={};this.compiled=!1;this.attributes={};this.uniforms={};this.fragmentShader=this.vertexShader="";this.includes={vertex:[],fragment:[]}};f.Program.types={f:"float",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4",t:"sampler2D"};f.Program.prototype={include:function(a,b){if(0<=this.includes[b].indexOf(a))return!0;this.includes[b].push(a);return!1},external:function(a,b){b=_.extend({category:a},
b);this.externals[b.name]=b},variable:function(a,b,e){e=_.extend({},e,{name:b});this.variables[a][b]=e},add:function(a,b,e,f,i){var g=this.calls[a][b];g?g.priority=Math.min(g.priority,i):this.calls[a][b]={name:b,args:e,code:f,priority:i}},compile:function(){_.each(this.externals,function(a){"uniform"==a.category&&(this.uniforms[a.name]={type:a.type,value:a.value});"attribute"==a.category&&(this.attributes[a.name]={type:a.type,value:[]})}.bind(this));_.each(["vertex","fragment"],function(a){var b=
[];_.each(this.externals,function(e){"attribute"==e.category&&"fragment"==a||b.push([e.category,e.signature,";"].join(" "))}.bind(this));var b=b.join("\n"),e=_.toArray(this.calls[a]),h=[b],i=["void main() {"];_.each(this.variables[a],function(a){i.push([f.Program.types[a.type],a.name,";"].join(" "))});e.sort(function(a,b){return b.priority-a.priority});_.each(e,function(a){h.push(a.code);i.push([a.name,"(",a.args.join(","),");"].join(""))});i.push("}");this[a+"Shader"]=[h.join("\n"),i.join("\n")].join("\n")}.bind(this));
this.compiled=!0},material:function(){if(!this.compiled)throw"Fetching material from uncompiled program.";return new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:this.vertex,fragmentShader:this.fragment})}}})(ShaderGraph);
(function(f){f.Snippet=function(a){if(f.Snippet.cache[a])return f.Snippet.cache[a];f.Snippet.cache[a]=this;this.code=a;this.attributes=[];this.uniforms=[];this.varyings=[];this.parameters=[];this.body=this.signature="";this.parseCode(a)};f.Snippet.cache={};f.Snippet.types={"float":"f",vec2:"v2",vec3:"v3",vec4:"v4",mat3:"m3",mat4:"m4",sampler2D:"t",samplerCube:"t"};f.Snippet.defaults={"float":0,vec2:new THREE.Vector3,vec3:new THREE.Vector3,vec4:new THREE.Vector4,mat4:new THREE.Matrix4,sampler2D:0,
samplerCube:0};f.Snippet.prototype={compile:function(a,b,e){var f=this.signature.slice(),i=[],b=b||[];_.each(this.uniforms,function(a){0<=b.indexOf(a.name)?f.push(a.signature):e||i.push(["uniform",a.signature].join(" "))});!e&&_.each(this.attributes,function(a){i.push(["attribute",a.signature].join(" "))});!e&&_.each(this.varyings,function(a){i.push(["varying",a.signature].join(" "))});a=this.body.replace(/\s*void\s+([A-Za-z0-9]+)\s*\([^\)]*\)/g,["void",a+"(",f.join(", "),")"].join(" "));i.push(a);
return i.join(";\n")},arguments:function(){return{uniforms:this.uniforms,varyings:this.varyings,attributes:this.attributes,parameters:this.parameters}},type:function(a,b){a=(f.Snippet.types[a]||"f")+(b?"v":"");return"fv"==a?"fv1":a},parseAttribute:function(a){var b=a[1];this.attributes.push({name:a[3],type:this.type(a[2],a[4]),signature:b})},parseUniform:function(a){var b=a[1],e=a[2];this.uniforms.push({name:a[3],type:this.type(e,a[4]),value:f.Snippet.defaults[e]||0,signature:b})},parseVarying:function(a){var b=
a[1];this.varyings.push({name:a[3],type:this.type(a[2],a[4]),signature:b})},parseSignature:function(a){this.name=a[1];var b=a[2].replace(/^\s*$/g,"");0==b.length?this.signature=[]:(arguments=this.signature=b.split(","),_.each(arguments,function(a){var a=/((?:(in|out|inout)\s+)?([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/.exec(a),b=a[1];this.parameters.push({inout:{"in":f.IN,out:f.OUT,inout:f.INOUT}[a[2]||"in"],name:a[4],type:this.type(a[3],a[5]),signature:b})}.bind(this)))},parseCode:function(a){function b(a,
b){if(!a.global)throw"Can't findAll non-global regexp";for(var e,f=[];e=a.exec(b);)f.push(e);return f}var a=a.replace(/\r\n?/g,"\n").replace(/\/\/[^\n]*\n/g," ").replace(/\/\*(.|\n)*?\*\//g," "),e=b(/(?:^|;)\s*attribute\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),f=b(/(?:^|;)\s*uniform\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),i=b(/(?:^|;)\s*varying\s+(([A-Za-z0-9]+)\s+([[A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),g=b(/(?:^|;)\s*void\s+([A-Za-z0-9]+)\s*\(([^\)]*)\)\s*{/g,
a);if(!g[0])throw"Could not parse shader snippet. Must contain a void-returning function with in/outs: "+a;var l=a;_.each({parseAttribute:e,parseUniform:f,parseVarying:i},function(a,b){_.each(a,function(a){this[b](a);l=l.replace(a[0],"")}.bind(this))}.bind(this));l=l.replace(/^\s*;/,"");this.parseSignature(g[0]);this.body=l}}})(ShaderGraph);
(function(f){f.Graph=function(a,b){this.parent=b||null;this.nodes=[];a&&this.add(a)};f.Graph.prototype={iterate:function(a){_.each(this.nodes,function(b){a(b,b._owner)})},exposed:function(){var a=[];this.iterate(function(b){_.each(b.outlets(),function(b){b.exposed&&a.push(b)})});return a},inputs:function(){var a=[];this.iterate(function(b){_.each(b.inputs,function(b){null==b.input&&a.push(b)})});return a},outputs:function(){var a=[];this.iterate(function(b){_.each(b.outputs,function(b){0==b.output.length&&
a.push(b)})});return a},tail:function(){return this.nodes[this.nodes.length-1]},add:function(a){if(a.constructor==Array)return _.each(a,function(a){this.add(a)}.bind(this));if(a.graph)throw"Adding node to two graphs at once";a.link(this);this.nodes.push(a)},remove:function(a,b){var e=this;if(a.constructor==Array)return _.each(a,function(a){e.remove(a)});if(a.graph!=this)throw"Removing node from wrong graph.";b||a.disconnect();this.nodes.splice(this.nodes.indexOf(a),1)}};f.IN=0;f.OUT=1;f.INOUT=2})(ShaderGraph);
(function(f){f.Node=function(a,b){this.graph=null;this.inputs=[];this.outputs=[];this._outlets={};this.owner(a);this.outlets(b)};f.Node.prototype={owner:function(a){return void 0!==a?(this._owner=a,this):this._owner},link:function(a){this.graph=a},getIn:function(a){return this.get(a,f.IN)},getOut:function(a){return this.get(a,f.OUT)},get:function(a,b){return void 0===b?this.get(a,f.IN)||this.get(a,f.OUT):this._outlets[[a,b].join("-")]},key:function(a){return[a.name,a.inout].join("-")},outlets:function(a){if(void 0!==
a){var b={};_.each(a,function(a){b[[a.name,a.inout,a.type].join("-")]=!0}.bind(this));_.each(this._outlets,function(a){b[[a.name,a.inout,a.type].join("-")]||this.remove(a)}.bind(this));_.each(a,function(a){var b=this.get(a.name,a.inout);b?b.morph(a):(a=new f.Outlet(a),this.add(a))}.bind(this));return this}return this._outlets},add:function(a){var b=this.key(a);outlets=this._outlets;_in=this.inputs;_out=this.outputs;if(a.node)throw"Adding outlet to two nodes at once.";if(outlets[b])throw"Adding two identical outlets to same node.";
a.link(this);outlets[b]=a;(a.inout==f.IN?_in:_out).push(a);return this},remove:function(a){var b=this._outlets,e=this.key(a),h=a.inout==f.IN?this.inputs:this.outputs;if(a.node!=this)throw"Removing outlet from wrong node.";a.disconnect();a.link(null);delete b[e];h.splice(h.indexOf(a),1);return this},connect:function(a,b,e){var f={},i={};_.each(a.inputs,function(a){if(e||!a.input){var b=a.type,k=[b,a.hint].join("-");i[k]||(i[k]=a);f[b]=f[b]||[];f[b].push(a)}});_.each(this.outputs,function(a){if(!b||
!a.output.length){var e=a.type,k=[e,a.hint].join("-");i[k]?(i[k].connect(a),delete i[k],f[e].splice(f[e].indexOf(a),1)):f[e]&&f[e].length&&f[e].shift().connect(a)}});return this},disconnect:function(){_.each(this.inputs,function(a){a.disconnect()});_.each(this.outputs,function(a){a.disconnect()});return this}}})(ShaderGraph);
(function(f){f.Outlets=0;f.Outlet=function(a,b,e,h,i,g,l){if("object"==typeof a)return new f.Outlet(a.inout,a.name,a.hint,a.type,a.category,a.exposed);this.node=null;this.inout=a;this.name=b;this.hint=e||b;this.type=h;this.category=i;this.exposed=!!g;this.meta=l||{};this.index=++f.Outlets;this.input=this.key=null;this.output=[]};f.Outlet.prototype={id:function(){return["_sg",this.name,this.index].join("_")},expose:function(a){this.exposed=a},morph:function(a){this.inout=a.inout;this.name=a.name;this.type=
a.type;this.category=a.category;this.exposed=a.exposed;this.meta=a.meta||{}},connect:function(a){if(this.inout==f.IN&&a.inout==f.OUT)return a.connect(this);if(this.inout!=f.OUT||a.inout!=f.IN)throw console.log(this,a),"Can't connect out/out or in/in outlets.";a.input!=this&&(a.disconnect(),a.input=this,this.output.push(a))},disconnect:function(a){if(this.inout==f.IN)this.input&&this.input.disconnect(this);else if(a){var b=this.output.indexOf(a);0<=b&&(this.output.splice(b,1),a.input=null)}else _.each(this.output,
function(a){a.input=null}),this.output=[]},link:function(a){this.node=a}}})(ShaderGraph);
